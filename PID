#include <Wire.h>
#include <mpu6050_FastAngles.h>
#include <Math.h>
double Kp_roll = 1.0, Ki_roll = 0.0, Kd_roll = 0.0;
double Kp_pitch = 1.0, Ki_pitch = 0.0, Kd_pitch = 0.0;
double Kp_yaw = 0.5, Ki_yaw = 0.0, Kd_yaw = 0.0;
double errorX, errorY, errorZ;
mpu6050_FastAngles mpu;
const float directional_heading = -4.09;
const float rad_to_deg = 180/PI;
float yaw, magnetic_heading;
magAddress = 0x0D;
void setup() {
  
    Serial.begin(9600);
    Wire.begin();
    mpu.PrintSettings();
 
}

void loop() {
 time = micros;
 float roll = mpu.getAngle('X', KALMAN);
 float pitch = mpu.getAngle('Y', KALMAN);
 float angleZ = mpu.getAngle('Z');
  Wire.beginTransmission(magAddress);
  Wire.write(0x00);
  Wire.endTransmission();
  Wire.requestFrom(magAddress, 6);
  byte x_lsb = Wire.read();
  byte x_msb = Wire.read();
  byte y_lsb = Wire.read();
  byte y_msb = Wire.read();
  byte z_lsb = Wire.read();
  byte z_msb = Wire.read();
  int16_t magx = x_msb << 8|x_lsb;
  int16_t magy = y_msb << 8|y_lsb;
  int16_t magz = z_msb << 8|z_lsb;

  magnetic_heading = atan2(magy,magx)*rad_to_deg;
  
  if (magnetic_heading) < 0 {
    magnetic_heading = magnetic_heading + 360;
  }
  if (magnetic_heading > 360) {
    magnetic_heading = magnetic_heading - 360;
  }
  
  yaw = magnetic_heading + directional_heading;

  if (yaw < 0) {
    yaw = yaw + 360;
  }
  if (yaw > 360) {
    yaw = yaw - 360;
  }

errorX =  setpoint - roll;
errorY = setpoint - pitch;
errorZ = setpoint - yaw;
currentTime = time;

}
